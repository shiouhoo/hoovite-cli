#!/usr/bin/env node
import e from"inquirer";import r from"fs";import t from"ora";import o from"path";import{fileURLToPath as i}from"url";import{Worker as n}from"worker_threads";import a from"os";import{spawn as s}from"child_process";const c=t("正在下载模板..."),m=t("删除原有文件夹...");function l(e,t){if(r.statSync(e).isDirectory()){r.mkdirSync(t,{recursive:!0});for(const i of r.readdirSync(e)){l(o.resolve(e,i),o.resolve(t,i))}}else r.copyFileSync(e,t)}(async()=>{try{const t=o.join(o.dirname(i(import.meta.url)),"../"),p=o.resolve();console.log(p);const f=await(async()=>({...await e.prompt([{type:"input",name:"projectName",message:"项目名称:",filter:e=>e.trim(),validate(e){return!(!(r=e)||!/^(?:@[a-z\d\-*~][a-z\d\-*._~]*\/)?[a-z\d\-~][a-z\d\-._~]*$/.test(r))||"项目名称不合法！";var r}},{type:"confirm",name:"overwrite",message:"目标文件夹已存在，是否要覆盖?",when:e=>r.existsSync(e.projectName)},{type:"input",name:"overwriteChecker",when(e){if(!1===e.overwrite)throw new Error("Operation cancelled");return null}},{type:"list",name:"templateName",message:"请选择你的模版",default:"vue3-ts",choices:[{name:"vue3-ts",value:"vue3-ts"}]}])}))(),{templateName:d,projectName:u,overwrite:w}=f;w&&(m.start(),await new Promise((e=>{new n(o.join(t,"src/clearDir.js"),{workerData:u}).on("message",e)})),m.succeed()),c.start();const y=o.join(t,`src/template/${d}`);console.log(1,y,o.join(p,u)),l(y,o.join(p,u));const j=JSON.parse(r.readFileSync(o.join(y,"package.json"),"utf-8"));j.name=u,r.writeFileSync(o.join(p,u+"/package.json"),JSON.stringify(j,null,2)+"\n"),"win32"===a.platform()?s("cmd.exe",["/c",`cd /d ${o.join(p,u)} && git init`]):s("sh",["-c",`cd "${o.join(p,u).replaceAll("\\","/")}" && git init`]),c.succeed(),console.log("下载成功")}catch(e){if("Operation cancelled"===e.message)return;console.log(e),c.fail()}})();
