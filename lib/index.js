#!/usr/bin/env node
import e from"inquirer";import n from"fs";import t from"ora";import o from"path";import{fileURLToPath as i}from"url";import{Worker as r}from"worker_threads";import{spawn as s}from"child_process";import p from"os";const m=t("正在下载模板..."),a=t("删除原有文件夹...");function l(e,t){if(n.statSync(e).isDirectory()){n.mkdirSync(t,{recursive:!0});for(const i of n.readdirSync(e)){l(o.resolve(e,i),o.resolve(t,i))}}else n.copyFileSync(e,t)}let c="\nimport { defineConfig } from 'vite';\nimport AutoImport from 'unplugin-auto-import/vite';\nimport Components from 'unplugin-vue-components/vite';\n";(async()=>{try{const t=o.join(o.dirname(i(import.meta.url)),"../"),u=o.resolve(),f=await(async()=>({...await e.prompt([{type:"input",name:"projectName",message:"项目名称:",filter:e=>e.trim(),validate(e){return!(!(n=e)||!/^(?:@[a-z\d\-*~][a-z\d\-*._~]*\/)?[a-z\d\-~][a-z\d\-._~]*$/.test(n))||"项目名称不合法！";var n}},{type:"confirm",name:"overwrite",default:!0,message:"目标文件夹已存在，是否要覆盖？",when:e=>n.existsSync(e.projectName)},{type:"input",name:"overwriteChecker",when(e){if(!1===e.overwrite)throw new Error("Operation cancelled");return null}},{type:"list",name:"templateName",message:"请选择你的模版",default:"vue3-ts",choices:[{name:"vue3-ts",value:"vue3-ts"}]},{type:"confirm",name:"unocss",message:"你是否需要unocss？",default:!0,when:e=>"vue3-ts"===e.templateName},{type:"list",name:"uiComponet",message:"是否需要UI组件库",choices:["不需要","element-plus","ant-design-vue","vant"],default:"不需要",when:e=>"vue3-ts"===e.templateName}])}))(),{templateName:v,projectName:d,overwrite:g}=f,y=o.join(u,d);g&&(a.start(),await new Promise((e=>{new r(o.join(t,"src/clearDir.js"),{workerData:d}).on("message",e)})),a.succeed()),m.start();const w=o.join(t,`src/template/${v}`);l(w,y);let S=n.readFileSync(o.join(y,"vite.config.ts"),"utf-8"),A=n.readFileSync(o.join(y,"src/main.ts"),"utf-8");const j=JSON.parse(n.readFileSync(o.join(w,"package.json"),"utf-8"));j.name=d,({viteConfig:S,mainFile:A}=((e,n,t,i,r,s)=>{if("vue3-ts"!==e.templateName)return{viteConfig:r,mainFile:s};n.devDependencies["unplugin-auto-import"]="^0.16.6";const p=[],m=[];return e.unocss&&(n.devDependencies.unocss="^0.56.5",r=(r=r.replace("import { defineConfig } from 'vite';","import { defineConfig } from 'vite';\r\nimport UnoCSS from 'unocss/vite';")).replace("vue(),","vue(),\r\n        UnoCSS(),"),l(o.join(t,"src/template/uno.config.ts"),o.join(i,"uno.config.ts")),s=s.replace("createApp(App).mount('#app');","import 'virtual:uno.css';\r\n\r\ncreateApp(App).mount('#app');")),"element-plus"===e.uiComponet?(c+="import { ElementPlusResolver } from 'unplugin-vue-components/resolvers';",p.push("ElementPlusResolver()"),m.push("ElementPlusResolver()"),n.dependencies["element-plus"]="^2.4.1",n.devDependencies["unplugin-vue-components"]="^0.25.2",r=r.replace("import { defineConfig } from 'vite';",c),s=s.replace("import App from './App.vue';","import 'element-plus/dist/index.css';\r\nimport App from './App.vue';")):"ant-design-vue"===e.uiComponet&&(c+="import { AntDesignVueResolver } from 'unplugin-vue-components/resolvers';",m.push("AntDesignVueResolver()"),n.dependencies["ant-design-vue"]="4.x",n.devDependencies["unplugin-vue-components"]="^0.25.2",r=r.replace("import { defineConfig } from 'vite';",c),s=s.replace("import App from './App.vue';","import 'ant-design-vue/dist/reset.css';\r\nimport App from './App.vue';")),{viteConfig:r=(r=(r=r.replace("componentsResolvers",JSON.stringify(m).replaceAll('"',""))).replace("autoImporResolvers",JSON.stringify(p).replaceAll('"',""))).replace("autoImportList",JSON.stringify(["vue"]).replaceAll('"',"'")),mainFile:s}})(f,j,t,y,S,A)),n.writeFileSync(o.join(y,"package.json"),JSON.stringify(j,null,2)+"\n"),(async e=>{"win32"===p.platform()?s("cmd.exe",["/c",`cd /d ${e} && git init`]):s("sh",["-c",`cd "${e.replaceAll("\\","/")}" && git init`])})(y),m.succeed(),n.writeFileSync(o.join(y,"vite.config.ts"),S),n.writeFileSync(o.join(y,"src/main.ts"),A),console.log("下载成功")}catch(e){if("Operation cancelled"===e.message)return;console.log(e),m.fail()}})();
